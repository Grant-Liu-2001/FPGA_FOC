# FOC(FPGA实现)

## 本次实习主要任务：

用FPGA完成FOC算法，并驱动电机。

## 主要成果：

1. 在前人的基础上，用FPGA完成并改进FOC算法，成功完成电流环并对电流环PID进行调整
2. 将电流环的控制频率从15kHz提高到30kHz
3. 在电流环的基础上加入转速环，用磁编码器采集的角度数据计算出电机的转速，并且用PID控制使电机恒转速输出
4. 在电流进行Park变换后加入低通滤波，用FPGA写低通滤波函数
5. 增加了电流、转速等参数寄存的长度，用拓展变量位数的方式模拟浮点数运算
6. 通过滤波与调参，使电机在空载状态下转速误差为3%，带300g负载状态下转速误差为5%

## 时钟分频（位置：foc_top.sv）：

采用普通的EN时钟分频，开发板工作频率为120MHz，如需更精确的时钟可改为PLL锁相环

目前时钟分频为60MHz（2分频）

## 低通滤波（位置：park_tr.sv）：

将数据拓展为27位，即增大2^12=4096

简单理解：将4096看作1。例如：new数据前的系数为26，则new数据权重为26/4096=0.006

新旧权重比为26：4070，该取值可以达到空载误差3%，但电机的响应很差，所以电机启动时很卡是正常现象

## 串口读取：

参数照着给的公式算就行

但是没办法放到上位机看曲线，因为给的字符有时候会出错，我看曲线的方法是放到XCOM读，把数据打印下来，去掉错误字符，放到EXCEL之后生成表格

## 转速环（speed.v）：

不稳定，可能的原因是把变量增大，时钟频率调快以后整个响应都变了

之前有一版可以用，可以去git看看历史

## 其它：

我参考的源代码已经整合成压缩包放进git了（FPGA-FOC-main.zip）

源代码运行时电机不转，要用手拨一下，原因就是变量没有小数部分（太小了，最大才200），相当于没有小数部分，电机转不起来

之前有一版转速环的电流环响应都OK，但是空载误差太大（大概10%）
